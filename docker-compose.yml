version: '3.9'

services:
  php:
    image: php:8.3-fpm-alpine
    container_name: tjw_php
    restart: unless-stopped
    user: "33:33"        # 👈 wymusza UID/GID zgodne z hostem Debian/Ubuntu
    volumes:
      - /var/www/tatajestwazny:/var/www/html
    networks:
      - traefik_net
      - tjw_net

  nginx:
    image: nginx:stable
    container_name: tjw_nginx
    restart: unless-stopped
    depends_on:
      - php
    expose:
      - "80"
    volumes:
      - /var/www/tatajestwazny:/var/www/html
      - /var/www/tatajestwazny/nginx.conf:/etc/nginx/conf.d/default.conf:rw

    labels:
      # 🔧 Aktywacja integracji z Traefikiem
      - "traefik.enable=true"

      # ===========================================
      # 🌐 Jeden router obsługujący wszystkie domeny
      # ===========================================
      - "traefik.http.routers.tatajestwazny.rule=Host(`tatajestwazny.pl`) || Host(`www.tatajestwazny.pl`) || Host(`app.tatajestwazny.pl`)"
      - "traefik.http.routers.tatajestwazny.entrypoints=websecure"
      - "traefik.http.routers.tatajestwazny.tls.certresolver=cloudflare"

      # 🔹 Jeden wspólny backend (port 80)
      - "traefik.http.services.tatajestwazny.loadbalancer.server.port=80"

    networks:
      - traefik_net
      - tjw_net

networks:
  traefik_net:
    external: true    # współdzielona sieć z Traefikiem
  tjw_net:
    external: true    # prywatna sieć Nginx <-> PHP
